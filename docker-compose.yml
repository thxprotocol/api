version: '3.5'

services:
    api_mongo:
        container_name: thx_api_mongo
        image: mongo
        env_file: .env.example
        restart: always
        ports:
            - 27017:27017
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: root
            MONGO_INITDB_DATABASE: admin
        volumes:
            - mongo-data:/data/db
            - ./scripts/mongo-init.sh:/docker-entrypoint-initdb.d/mongo-init.sh

    api_hardhat:
        container_name: thx_api_hardhat
        image: public.ecr.aws/o5j5y3t5/hardhat-thx-artifacts:3.1.21
        domainname: hardhat.thx.local
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
        ports:
            - 8547:8545
        expose: 
            - 8545
        environment:
            - VIRTUAL_HOST=hardhat.thx.local
            - VIRTUAL_PORT=8545

    api_nginx:
        image: nginx:1.17.10
        container_name: thx_api_nginx
        depends_on:
            - api_hardhat
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf
            - ./certs/nginx.key:/etc/nginx/certs/nginx.key
            - ./certs/nginx.pem:/etc/nginx/certs/nginx.pem
        ports:
            - 8546:443
                
    postgres:
        image: postgres:12
        volumes:
            - database:/var/lib/postgresql/data
            - app:/app
        expose:
            - 5432
        ports:
            - "5432:5432"
        environment:
            POSTGRES_USER: "arweave"
            POSTGRES_PASSWORD: "arweave"
            POSTGRES_DB: "arweave"
        command: -p 5432
        networks:
            - sub-etha
    # Arweave Node Configurations
    arweave-node:
        image: lucaarweave/arweave-node:0.0.4
        expose:
            - 1984
        ports:
            - "1984:1984"
        environment:
            AR_RUNMODE: "test"
        volumes:
            - "ardata:/mnt/arweave-data"
            # restart: "always"
        networks:
            - sub-etha
    # Arweave Gateway configuration
    arweave-gateway:
        image: lucaarweave/arweave-gateway:0.0.1
        volumes:
            - app:/app
        links:
            - postgres
            - arweave-node
        expose:
            - 3000
        ports:
            - "4000:3000"
        networks:
            - sub-etha
    # The TestWeave net
    testweave:
        image: "ghcr.io/demo-hub/testweave-net:latest"
        container_name: testweave
        links:
            - postgres
            - arweave-node
            - arweave-gateway
        ports:
            - "80:80"
        expose:
            - 80
        networks:
            - sub-etha

volumes:
    app:
    database:
    ardata:
    mongo-data:
networks:
    sub-etha:
